<!DOCTYPE html>
<html>
  <head>
    <title>NFS</title>
    <link rel="stylesheet" href="loader.css" />
    <link rel="stylesheet" href="MainPage.css" />

    <style type="text/css"></style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navdiv">
        <div class="logo"><a href="index.html">Nature Foot Spa</a></div>
        <ul>
          <li><a href="#home">Home</a></li>
          <li><a href="#booking-sections">Book Now</a></li>
          <li><a href="#contact-us">Contact</a></li>
          <li><a href="aboutus.html">About Us</a></li>
          <li><a href="accountsettings.html">Profile</a></li>
        </ul>
      </div>
    </nav>
    <!--Transition effect for services-->
    <main data-router-wrapper>
      <section data-router-view="home" class="home">
        <div class="home-content"></div>
      </section>
    </main>

    <!-- Welcome Banner -->
    <div class="welcome-banner" id="home">
      <img src="images/welcomeimg.png" alt="Welcome Image" />
      <div class="welcome-text">
        <h1>Welcome to Nature's Foot Spa</h1>
        <p>Relax, refresh, and rejuvenate with our signature treatments.</p>
      </div>
    </div>

    <section class="booking-section" id="booking-sections">
      <h1><strong>Book Your Appointment</strong></h1>
      <p>Select your preferred service, date, and time.</p>

      <div class="booking-options">
        <!-- Service 1 -->
        <div class="booking-card">
          <img src="images/hotstone.png" alt="Hot Stone Massage" />
          <h3>Hot Stone Massage</h3>
          <p><strong>60 min</strong></p>
          <a href="service1.html?service_id=2" class="confirm-btn">Book Now</a>
        </div>

        <!-- Service 2 -->
        <div class="booking-card">
          <img src="images/footsoak.png" alt="Aromatherapy Foot Soak" />
          <h3>Aromatherapy Foot Soak</h3>
          <p><strong>30 min</strong></p>
          <a href="service1.html?service_id=3" class="confirm-btn">Book Now</a>
        </div>

        <!-- Service 3 -->
        <div class="booking-card">
          <img src="images/reflexology.png" alt="Reflexology" />
          <h3>Reflexology</h3>
          <p><strong>60 min</strong></p>
          <a href="service1.html?service_id=4" class="confirm-btn">Book Now</a>
        </div>

        <!-- Service 4 -->
        <div class="booking-card">
          <img
            src="images/Deeptissuefootmassage.png"
            alt="Deep Tissue Foot Massage"
          />
          <h3>Deep Tissue Foot Massage</h3>
          <p><strong>50 min</strong></p>
          <a href="service1.html?service_id=5" class="confirm-btn">Book Now</a>
        </div>

        <!-- Service 5 -->
        <div class="booking-card">
          <img src="images/sig.jpg" alt="Nature's Foot Spa Signature" />
          <h3>Nature's Foot Spa Signature</h3>
          <p><strong>90 min</strong></p>
          <a href="service1.html?service_id=1" class="confirm-btn">Book Now</a>
        </div>
      </div>
    </section>
    <div class="contact-container">
      <!-- Left Side Info -->
      <div class="contact-info">
        <h2>We'd love to hear from you!</h2>
        <p>
          We value each customer’s perspective and cherish the opportunity to
          hear from you. Whether you have a question, feedback, or just want to
          share your thoughts, we encourage you to reach out.
        </p>

        <div class="contact-item">
          80 Eulogio Rodriguez Jr. Ave, Bagumbayan, Quezon City, 1110 Metro
          Manila
        </div>
        <div class="contact-item">
          Monday to Thursday / 8AM - 6PM <br />
          Friday / 8AM - 5PM
        </div>
        <div class="contact-item">(02) 8656 5790</div>
      </div>
    </div>

    <!-- Reviews Section -->
    <section id="reviews" style="padding:40px 5%; background:#f9fafb;">
      <h2 style="margin-bottom:16px;">What our clients say</h2>
      <div id="reviewsList" style="display:grid; gap:16px; margin-bottom:24px;"></div>

      <div id="reviewFormWrapper" style="max-width:480px; background:#ffffff; padding:16px 20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.03);">
        <h3 style="margin-top:0; margin-bottom:12px;">Leave a review</h3>
        <form id="reviewForm">
          <div style="margin-bottom:8px;">
            <label for="reviewName">Name</label>
            <input type="text" id="reviewName" placeholder="Your name" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd;" />
          </div>
          <div style="margin-bottom:8px;">
            <label for="reviewRating">Rating</label>
            <select id="reviewRating" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd;">
              <option value="5">5 - Excellent</option>
              <option value="4">4 - Very Good</option>
              <option value="3">3 - Good</option>
              <option value="2">2 - Fair</option>
              <option value="1">1 - Poor</option>
            </select>
          </div>
          <div style="margin-bottom:12px;">
            <label for="reviewComment">Comment</label>
            <textarea id="reviewComment" placeholder="Share your experience" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd;"></textarea>
          </div>
          <button type="submit" style="padding:8px 16px; border-radius:999px; border:none; background:#2563eb; color:#fff; cursor:pointer;">Submit review</button>
        </form>
        <p id="reviewFormNote" style="font-size:12px; color:#6b7280; margin-top:8px;"></p>
      </div>
    </section>

    <div class="loader"></div>

    <script src="load.js" defer></script>
    <script>
      // Non-destructive service sync: fetch services from backend and append any that
      // are not already present on the page (so existing hard-coded cards remain).
      (async function(){
        
        async function loadBackendServices() {
          try{
            // Use full URL to ensure it hits the backend server
            const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://localhost:3000' : '';
            console.log('Loading services from:', API_BASE + '/api/services');
            const res = await fetch(API_BASE + '/api/services');
            if(!res.ok) {
              console.log('API response not OK:', res.status, res.statusText);
              return;
            }
            const data = await res.json();
            console.log('API response data:', data);
            const services = Array.isArray(data) ? data : (data && data.data ? data.data : []);
            if(!services || !services.length) {
              console.log('No services found in response');
              return;
            }
            console.log('Found', services.length, 'services to process');

            const container = document.querySelector('.booking-options');
            if(!container) return;

            // Build a set of existing service titles to avoid duplicates
            const existing = new Set(Array.from(container.querySelectorAll('h3')).map(h=>h.textContent.trim().toLowerCase()));

            services.forEach(s=>{
              const name = (s.SERVICE_NAME || s.NAME || s.service_name || s.name || '').toString().trim();
              console.log('Processing service:', name);
              if(!name) return;
              if(existing.has(name.toLowerCase())) {
                console.log('Service already exists, skipping:', name);
                return; // skip if already on page
              }

              const img = s.IMAGE_URL || s.IMG || 'images/sig.jpg';
              const dur = s.DURATION || s.duration || '60 min';
              const id = s.SERVICE_ID || s.service_id || s.id || '';

              console.log('Adding new service to page:', name);
              const card = document.createElement('div');
              card.className = 'booking-card';
              card.innerHTML = `
                <img src="${img}" alt="${name}" />
                <h3>${name}</h3>
                <p><strong>${dur}</strong></p>
                <a href="service1.html?service_id=${id}" class="confirm-btn">Book Now</a>
              `;
              container.appendChild(card);
            });
          }catch(err){
            console.warn('Could not sync services from API:', err.message);
          }
        }

        // Call on page load
        loadBackendServices();
        
        // REAL-TIME UPDATES: Listen for service updates from admin panel
        window.refreshServices = function() {
          loadBackendServices();
        };
        
        // Also listen to localStorage changes for cross-tab communication
        window.addEventListener('storage', function(e) {
          if (e.key === 'servicesUpdated') {
            setTimeout(loadBackendServices, 100); // Small delay to ensure DB is updated
          }
        });
        
        // Check periodically in case localStorage event doesn't fire
        setInterval(function() {
          const lastUpdate = localStorage.getItem('servicesUpdated');
          if (lastUpdate && Date.now() - parseInt(lastUpdate) < 5000) {
            // If updated in last 5 seconds, refresh
            loadBackendServices();
            localStorage.removeItem('servicesUpdated'); // Clear the flag
          }
        }, 1000);
      
        // ===== Reviews =====
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://localhost:3000' : '';

        function escapeHtml(str){
          return String(str || '').replace(/[&<>\"]/g, function(tag){
            const chars = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'};
            return chars[tag] || tag;
          });
        }

        function renderReviews(items){
          const list = document.getElementById('reviewsList');
          if(!list) return;
          list.innerHTML = '';

          if(!items || !items.length){
            list.innerHTML = '<p style="color:#6b7280;">No reviews yet. Be the first to share your experience!</p>';
            return;
          }

          items.forEach(r => {
            const card = document.createElement('div');
            card.className = 'review-card';
            const stars = '★★★★★'.slice(0, Number(r.RATING || r.rating || 0));
            const name = r.NAME || r.name || 'Guest';
            const comment = r.COMMENT || r.comment || '';
            const dateStr = r.CREATED_AT ? new Date(r.CREATED_AT).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : '';
            card.innerHTML = `
              <div class="review-card-header">
                <span class="review-card-name">${escapeHtml(name)}</span>
                <span class="review-card-stars">${escapeHtml(stars)}</span>
              </div>
              <p class="review-card-comment">${escapeHtml(comment)}</p>
              <span class="review-card-date">${escapeHtml(dateStr)}</span>
            `;
            list.appendChild(card);
          });
        }

        async function loadReviews(){
          try{
            const res = await fetch(API_BASE + '/api/reviews');
            if(!res.ok) return;
            const data = await res.json();
            const items = Array.isArray(data) ? data : (data && data.data ? data.data : []);
            renderReviews(items);
          }catch(err){
            console.warn('Could not load reviews:', err.message);
          }
        }

        function initReviewForm(){
          const form = document.getElementById('reviewForm');
          const noteEl = document.getElementById('reviewFormNote');
          if(!form) return;

          const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('jwt');
          if(!token && noteEl){
            noteEl.textContent = 'Log in to submit a review.';
          }

          form.addEventListener('submit', async function(e){
            e.preventDefault();
            const name = document.getElementById('reviewName').value.trim();
            const rating = document.getElementById('reviewRating').value;
            const comment = document.getElementById('reviewComment').value.trim();

            if(!name || !comment){
              if(noteEl) noteEl.textContent = 'Please provide your name and comment.';
              return;
            }

            if(!token){
              if(noteEl) noteEl.textContent = 'You need to log in before submitting a review.';
              return;
            }

            try{
              const res = await fetch(API_BASE + '/api/reviews', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ name, rating, comment })
              });

              const data = await res.json().catch(()=>({}));
              if(!res.ok){
                if(noteEl) noteEl.textContent = data.message || 'Failed to submit review.';
                return;
              }

              form.reset();
              if(noteEl) noteEl.textContent = 'Thank you for your review!';
              loadReviews();
            }catch(err){
              if(noteEl) noteEl.textContent = 'An error occurred while submitting your review.';
            }
          });
        }

        loadReviews();
        initReviewForm();

      })();
    </script>
  </body>
</html>
