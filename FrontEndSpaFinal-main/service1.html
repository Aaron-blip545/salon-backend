<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Service - Nature's Foot Spa</title>
    <link rel="stylesheet" href="servicedescriptionandinfo.css" />
  </head>
  <body>
    <main class="page" id="mainContent">
      <!-- LOADING STATE -->
      <section class="card loading" id="loadingState">
        <p>Loading service details...</p>
      </section>
    </main>

    <script>
      const API_BASE = "http://localhost:3000/api";
      let currentService = null;

      // Get service_id from URL parameter
      function getServiceIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("service_id");
      }

      // Load service details
      async function loadServiceDetails() {
        const serviceId = getServiceIdFromURL();

        console.log("Loading service ID:", serviceId);

        if (!serviceId) {
          showError(
            "No service selected. Please go back and select a service."
          );
          return;
        }

        try {
          console.log("Fetching from:", `${API_BASE}/services`);

          const response = await fetch(`${API_BASE}/services`);

          console.log("Response status:", response.status);

          const data = await response.json();

          console.log("Response data:", data);

          if (data.success && data.data && data.data.length > 0) {
            // Find the specific service
            const service = data.data.find((s) => s.SERVICE_ID == serviceId);

            console.log("Found service:", service);

            if (service) {
              currentService = service;
              displayService(service);
            } else {
              showError(
                `Service with ID ${serviceId} not found. Please go back and select a valid service.`
              );
            }
          } else {
            showError("No services available. Please contact support.");
          }
        } catch (error) {
          console.error("Fetch error:", error);
          showError(
            "Connection error: " +
              error.message +
              ". Make sure the backend server is running on localhost:3000"
          );
        }
      }

      // Display service details
      let selectedStaffId = null;
      let selectedStaffName = null;
      let selectedTimeSlot = null;
      let currentCalendarMonth = new Date().getMonth();
      let currentCalendarYear = new Date().getFullYear();
      let selectedDateStr = null; // yyyy-mm-dd
      const dayAvailabilityCache = {}; // dateStr -> { hasBookings, fullyBooked }
      let serviceDurationMinutes = 60; // default duration

      function displayService(service) {
        const mainContent = document.getElementById("mainContent");

        // derive duration in minutes from service.DURATION
        // supports DB time format (HH:MM:SS), "60 min", "90 mins", "1 hr", "2 hours", or plain numbers
        const rawDuration = service.DURATION || service.duration || "60";
        console.log('Service duration raw value:', rawDuration);
        const rawStr = String(rawDuration).trim();

        // 1) If value looks like a time (HH:MM or HH:MM:SS), convert to minutes
        if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(rawStr)) {
          const parts = rawStr.split(':');
          const h = parseInt(parts[0], 10) || 0;
          const m = parseInt(parts[1], 10) || 0;
          serviceDurationMinutes = h * 60 + m;
        } else {
          // 2) Fallback: extract first number and interpret based on units
          const matched = rawStr.match(/(\d+)/);
          if (matched) {
            const num = parseInt(matched[1], 10) || 60;
            if (/hour|hr/i.test(rawStr)) {
              // explicit hours
              serviceDurationMinutes = num * 60;
            } else if (!/min/i.test(rawStr) && num <= 12) {
              // plain small integer without 'min' -> assume hours (e.g. 1 => 1 hour)
              serviceDurationMinutes = num * 60;
            } else {
              // otherwise treat as minutes
              serviceDurationMinutes = num;
            }
          } else {
            serviceDurationMinutes = 60;
          }
        }
        console.log('Computed serviceDurationMinutes:', serviceDurationMinutes);

        mainContent.innerHTML = `
                <!-- PRODUCT DESCRIPTION -->
                <section class="product card">
                    <img class="product-img" 
                         src="images/service-${service.SERVICE_ID}.jpg" 
                         alt="${service.SERVICE_NAME}"
                         onerror="this.src='images/sig.jpg'" />

                    <div class="product-info">
                        <h1 class="product-title">${service.SERVICE_NAME}</h1>
                        <p class="product-tagline">${
                          service.SERVICE_NAME
                        } Service</p>

                        <p class="product-desc">
                            ${
                              service.DESCRIPTION ||
                              "Experience professional service tailored to your needs. Our expert team provides quality care with attention to detail."
                            }
                        </p>

                        <div class="price-row">
                            <div class="price">₱${parseFloat(
                              service.PRICE
                            ).toFixed(2)}</div>
                        </div>
                    </div>
                </section>

                <!-- DATE PICKER WITH CALENDAR -->
                <section class="datepicker card" aria-labelledby="booking-information">
                    <h2 id="booking-information">Booking Information</h2>
                    <p class="small">
                        Please select your preferred date and time. Available dates are weekdays only.
                    </p>

                    <form id="dateForm" class="date-form">
                        <input id="bookDate" name="bookDate" type="hidden" required />

                        <div class="calendar-wrapper">
                          <div class="calendar-header-row">
                            <button id="prevMonth" type="button" class="calendar-nav-btn">← Previous</button>
                            <h3 id="currentMonth" class="calendar-month-label">Month Year</h3>
                            <button id="nextMonth" type="button" class="calendar-nav-btn">Next →</button>
                          </div>
                          <div id="calendarGrid" class="calendar-grid">
                            <!-- Calendar days will be injected here -->
                          </div>
                          <div class="calendar-legend">
                            <div class="calendar-legend-item">
                              <div class="calendar-legend-box has-booking"></div>
                              <span>Has bookings</span>
                            </div>
                            <div class="calendar-legend-item">
                              <div class="calendar-legend-box fully-booked"></div>
                              <span>Fully booked</span>
                            </div>
                            <div class="calendar-legend-item">
                              <div class="calendar-legend-box today"></div>
                              <span>Today</span>
                            </div>
                            <div class="calendar-legend-item">
                              <div class="calendar-legend-box selected"></div>
                              <span>Selected date</span>
                            </div>
                          </div>
                        </div>

                        <p class="small">
                          Select your preferred staff and time slot after choosing a date.
                        </p>

                        <div class="form-actions">
                            <button id="clearBtn" type="button" class="clearBtn">Clear</button>
                        </div>
                    </form>
                </section>

                <!-- STAFF SELECTION -->
                <section class="card" id="staffSection">
                    <h2>Select Staff</h2>
                    <p class="small">Choose your preferred staff member for this service.</p>
                    <div id="staffList" style="margin-top:10px;">Loading staff...</div>
                    <p id="selectedStaffInfo" class="chosen" aria-live="polite"></p>
                </section>

                <!-- TIME SLOTS -->
                <section class="card" id="timeSlotsSection" style="display:none;">
                    <h2>Available Time Slots</h2>
                    <p class="small" id="selectedStaffLabel"></p>
                    <div id="timeSlotsGrid" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;"></div>
                </section>

                <!-- CONFIRMATION / BOOK BUTTON AT BOTTOM -->
                <section class="card" id="confirmSection">
                    <h2>Confirm Your Booking</h2>
                    <p class="small">
                      Review your selected date, staff, and time slot, then tap book to continue to payment.
                    </p>
                    <p id="chosen" class="chosen" aria-live="polite"></p>
                    <div class="form-actions bottom-actions">
                      <button id="bookSubmitBtn" type="button" class="btn">Book</button>
                    </div>
                </section>
            `;

        // Initialize form handlers after content is loaded
        initializeFormHandlers();
        loadStaff();
      }

      async function loadStaff() {
        try {
          const res = await fetch(`${API_BASE}/staff/active`);
          const data = await res.json();
          const staffListEl = document.getElementById("staffList");

          if (!data.success || !data.data || !data.data.length) {
            staffListEl.textContent = "No staff available.";
            return;
          }

          staffListEl.innerHTML = data.data
            .map(
              (s) => `
      <button class="staff-btn" data-staff-id="${s.staff_id}"
        data-staff-name="${s.full_name || ''}"
        data-staff-phone="${s.phone || s.PHONE || s.contact_number || s.CONTACT_NUMBER || ''}"
        style="border:1px solid #ccc;border-radius:8px;padding:8px 10px;margin:4px;cursor:pointer;background:#f9f9f9;">
        <div style="font-weight:600;">${s.full_name}</div>
        <div style="font-size:12px;color:#666;">
          ${s.role || "Massage Therapist"}${s.gender ? " • " + s.gender : ""}
        </div>
        ${
          s.phone || s.PHONE || s.contact_number || s.CONTACT_NUMBER
            ? `<div style="font-size:12px;color:#444;">${
                s.phone || s.PHONE || s.contact_number || s.CONTACT_NUMBER
              }</div>`
            : ""
        }
      </button>`
            )
            .join("");

          document.querySelectorAll(".staff-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".staff-btn")
                .forEach((b) => b.classList.remove("selected"));
              btn.classList.add("selected");
              selectedStaffId = btn.getAttribute("data-staff-id");
              document.getElementById("timeSlotsSection").style.display = "block";
              const staffName = btn.getAttribute("data-staff-name") || btn.textContent.trim();
              selectedStaffName = staffName;
              const staffPhone = btn.getAttribute("data-staff-phone") || "";
              let labelText = "Available times for " + staffName;
              if (staffPhone) {
                labelText += " (" + staffPhone + ")";
              }
              document.getElementById("selectedStaffLabel").textContent = labelText;

              const selectedInfo = document.getElementById("selectedStaffInfo");
              if (selectedInfo) {
                selectedInfo.textContent = staffPhone
                  ? `Selected staff: ${staffName} (${staffPhone})`
                  : `Selected staff: ${staffName}`;
              }

              const dateVal = document.getElementById("bookDate").value;
              if (dateVal) {
                loadTimeSlots(dateVal);
              }
            });
          });
        } catch (e) {
          console.error("Error loading staff", e);
          document.getElementById("staffList").textContent =
            "Failed to load staff.";
        }
      }

      function formatTimeToAmPm(time) {
        const [h, m] = time.split(":");
        let hour = parseInt(h, 10);
        const meridiem = hour >= 12 ? "PM" : "AM";
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${m} ${meridiem}`;
      }

      function addMinutesToTime(time, minutesToAdd) {
        const [h, m] = time.split(":");
        let totalMinutes = parseInt(h, 10) * 60 + parseInt(m, 10) + minutesToAdd;
        const endHour = Math.floor(totalMinutes / 60);
        const endMin = totalMinutes % 60;
        const hh = String(endHour).padStart(2, "0");
        const mm = String(endMin).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      // Helper: mark a specific time slot button as booked (red and disabled)
      function markSlotAsBooked(time) {
        const grid = document.getElementById("timeSlotsGrid");
        if (!grid) return;
        const btn = grid.querySelector(`button[data-time="${time}"]`);
        if (!btn) return;
        btn.disabled = true;
        btn.style.background = "#fde2e2"; // light red
        btn.style.color = "#a33";
        btn.style.borderColor = "#f28b82";
        btn.title = "This time slot has already been booked.";
      }

      async function loadTimeSlots(date) {
        if (!selectedStaffId) return;
        const grid = document.getElementById("timeSlotsGrid");
        grid.innerHTML = "Loading slots...";

        try {
          const res = await fetch(
            `${API_BASE}/bookings/available-slots?date=${encodeURIComponent(
              date
            )}&staff_id=${encodeURIComponent(selectedStaffId)}`
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "Failed to load slots");

          // Normalize booked slot times from API (e.g., "09:00:00") to match
          // the "HH:MM" format used by the front-end buttons (e.g., "09:00").
          const rawBooked = data.data.booked_slots || [];
          const booked = new Set(
            rawBooked.map((t) => {
              if (!t) return t;
              const str = String(t);
              // If it looks like HH:MM:SS, trim to HH:MM
              if (/^\d{2}:\d{2}:\d{2}$/.test(str)) {
                return str.slice(0, 5);
              }
              return str;
            })
          );
          const hours = [
            "09:00",
            "10:00",
            "11:00",
            "12:00",
            "13:00",
            "14:00",
            "15:00",
            "16:00",
            "17:00",
            "18:00",
            "19:00",
          ];

          grid.innerHTML = "";
          const allBookedForStaff = hours.every((time) => booked.has(time));

          hours.forEach((time) => {
            const isBooked = booked.has(time);
            const btn = document.createElement("button");
            const endTime = addMinutesToTime(time, serviceDurationMinutes);
            btn.textContent = `${formatTimeToAmPm(time)} - ${formatTimeToAmPm(
              endTime
            )}`;
            btn.setAttribute("data-time", time);

            // base style for all buttons
            btn.style.cssText =
              "padding:6px 10px;border-radius:6px;border:1px solid #ccc;cursor:pointer;font-size:13px;background:#f8f9fa;color:#333;min-width:70px;";

            if (isBooked) {
              // booked (red) and disabled
              btn.disabled = true;
              btn.style.background = "#fde2e2"; // light red
              btn.style.color = "#a33";
              btn.style.borderColor = "#f28b82";
              btn.title = "Already booked";
            } else {
              // available: clicking marks as selected (green)
              btn.addEventListener("click", () => {
                document
                  .querySelectorAll("#timeSlotsGrid button")
                  .forEach((b) => {
                    if (b.disabled) {
                      // keep booked style
                      b.style.background = "#fde2e2";
                      b.style.color = "#a33";
                      b.style.borderColor = "#f28b82";
                    } else {
                      // reset available style
                      b.style.background = "#f8f9fa";
                      b.style.color = "#333";
                      b.style.borderColor = "#ccc";
                    }
                  });

                // selected (green)
                btn.style.background = "#c8f7c5"; // light green
                btn.style.borderColor = "#2ecc71";
                btn.style.color = "#1b5e20";
                selectedTimeSlot = btn.getAttribute("data-time");

                // Re-enable the Book button now that a valid slot is selected
                const bookBtnEl = document.getElementById("bookSubmitBtn");
                if (bookBtnEl) {
                  bookBtnEl.disabled = false;
                }
              });
            }
            grid.appendChild(btn);
          });

          // If all possible slots for this staff on this date are booked, update label to indicate unavailability
          if (allBookedForStaff) {
            const label = document.getElementById("selectedStaffLabel");
            if (label) {
              label.textContent += " — No available time slots left for this staff on this date.";
            }
          }
        } catch (e) {
          console.error("Error loading slots", e);
          grid.textContent = "Failed to load time slots.";
        }
      }

      // Show error message
      function showError(message) {
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = `
                <section class="card" style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545; margin-bottom: 20px;">⚠️ Error</h3>
                    <p style="margin-bottom: 30px;">${message}</p>
                    <a href="index.html" class="btn" style="display: inline-block; text-decoration: none;">
                        Go Back to Home
                    </a>
                </section>
            `;
      }

      // Initialize form event handlers
      function initializeFormHandlers() {
        const bookingDate = document.getElementById("bookDate");
        const chosen = document.getElementById("chosen");
        const clearBtn = document.getElementById("clearBtn");
        const bookBtn = document.getElementById("bookSubmitBtn");
        const prevMonthBtn = document.getElementById("prevMonth");
        const nextMonthBtn = document.getElementById("nextMonth");

        // Set minimum date to tomorrow (no same-day bookings)
        const todayObj = new Date();
        const tomorrow = new Date(
          todayObj.getFullYear(),
          todayObj.getMonth(),
          todayObj.getDate() + 1
        );
        const minDateStr = tomorrow.toISOString().split("T")[0];
        bookingDate.setAttribute("min", minDateStr);

        // Calendar navigation
        if (prevMonthBtn) {
          prevMonthBtn.addEventListener("click", () => {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
              currentCalendarMonth = 11;
              currentCalendarYear--;
            }
            renderBookingCalendar();
          });
        }

        if (nextMonthBtn) {
          nextMonthBtn.addEventListener("click", () => {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
              currentCalendarMonth = 0;
              currentCalendarYear++;
            }
            renderBookingCalendar();
          });
        }

        // Validate weekday when hidden date value changes (triggered from calendar)
        bookingDate.addEventListener("change", () => {
          if (!bookingDate.value) {
            chosen.textContent = "";
            return;
          }

          const date = new Date(bookingDate.value + "T00:00:00");
          const day = date.getDay(); // 0 = Sunday, 6 = Saturday

          const todayCheck = new Date();
          todayCheck.setHours(0, 0, 0, 0);

          if (day === 0 || day === 6) {
            alert("Please select a weekday (Monday to Friday).");
            bookingDate.value = "";
            chosen.textContent = "";
            selectedDateStr = null;
            renderBookingCalendar();
            return;
          }

          if (date.getTime() === todayCheck.getTime()) {
            alert("You can't book on the current day. Please choose a future date.");
            bookingDate.value = "";
            chosen.textContent = "";
            selectedDateStr = null;
            renderBookingCalendar();
            return;
          }

          updateChosen();
        });

        // Clear button
        clearBtn.addEventListener("click", () => {
          bookingDate.value = "";
          chosen.textContent = "";
          selectedStaffId = null;
          selectedTimeSlot = null;
          const staffListEl = document.getElementById("staffList");
          const timeSlotsGrid = document.getElementById("timeSlotsGrid");
          const timeSlotsSection = document.getElementById("timeSlotsSection");
          if (staffListEl) {
            staffListEl.querySelectorAll(".staff-btn").forEach((b) =>
              b.classList.remove("selected")
            );
          }
          if (timeSlotsGrid) {
            timeSlotsGrid.innerHTML = "";
          }
          if (timeSlotsSection) {
            timeSlotsSection.style.display = "none";
          }

          selectedDateStr = null;
          bookingDate.value = "";
          renderBookingCalendar();
        });

        // Update chosen display
        function updateChosen() {
          const dateInput = bookingDate.value;

          if (dateInput && selectedTimeSlot) {
            const combined = `${dateInput} ${selectedTimeSlot}`;
            chosen.dataset.datetime = combined;

            const date = new Date(combined);
            const humanDate = date.toLocaleDateString("en-US", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            const humanTime = date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            });

            chosen.textContent = `You have chosen: ${humanDate} at ${humanTime}`;
          } else {
            chosen.textContent = "";
          }
        }

        async function submitBooking() {
          const date = bookingDate.value;

          // Validate inputs
          if (!date) {
            alert("Please select a date first!");
            return;
          }
          if (!selectedStaffId) {
            alert("Please select a staff member.");
            return;
          }
          if (!selectedTimeSlot) {
            alert("Please select a time slot.");
            return;
          }

          // Check if user is logged in
          const token = localStorage.getItem("token");
          if (!token) {
            alert("Please login first to book a service!");
            window.location.href = "loginform.html";
            return;
          }

          const bookingData = {
            service_id: currentService.SERVICE_ID,
            booking_date: date,
            booking_time: selectedTimeSlot,
            staff_id: selectedStaffId,
          };

          try {
            const resp = await fetch(`${API_BASE}/bookings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(bookingData),
            });

            const result = await resp.json();
            if (!resp.ok || !result.success) {
              throw new Error(result.message || "Failed to create booking");
            }

            const created = result.data || {};
            const username =
              localStorage.getItem("userName") ||
              localStorage.getItem("username") ||
              "Guest";

            sessionStorage.setItem(
              "bookingDetails",
              JSON.stringify({
                booking_id: created.BOOKING_ID || created.booking_id,
                service_id: bookingData.service_id,
                service_name: currentService.SERVICE_NAME,
                staff_id: selectedStaffId,
                staff_name: selectedStaffName,
                booking_date: bookingData.booking_date,
                booking_time: bookingData.booking_time,
                price: currentService.PRICE,
                username: username,
              })
            );

            window.location.href = "paymentmethod.html";
          } catch (error) {
            console.error("Booking error:", error);

            const msg = (error && error.message ? error.message : "").toLowerCase();
            const chosenMsgEl = document.getElementById("chosen");

            if (msg.includes("already booked") || msg.includes("time slot")) {
              // Mark the currently selected slot as booked so the user sees it as unavailable
              if (selectedTimeSlot) {
                markSlotAsBooked(selectedTimeSlot);
              }

              // Clear the selected time so the user must pick a new available slot
              selectedTimeSlot = null;

              // Disable the Book button until a new valid slot is chosen
              const bookBtnEl = document.getElementById("bookSubmitBtn");
              if (bookBtnEl) {
                bookBtnEl.disabled = true;
              }

              // Clear any previous confirmation message; rely on the red slot styling instead
              if (chosenMsgEl) {
                chosenMsgEl.textContent = "";
              }

              // Refresh slots for this date to catch any other new bookings
              if (selectedStaffId && date) {
                loadTimeSlots(date);
              }
            } else {
              alert("Could not create booking: " + (error.message || "Unknown error"));
            }
          }
        }

        if (bookBtn) {
          bookBtn.addEventListener("click", (e) => {
            e.preventDefault();
            submitBooking();
          });
        }

        // Initial calendar render
        renderBookingCalendar();
      }

      function renderBookingCalendar() {
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const monthTitle = document.getElementById("currentMonth");
        const calendarGrid = document.getElementById("calendarGrid");

        if (!monthTitle || !calendarGrid) return;

        monthTitle.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

        const today = new Date();
        const todayY = today.getFullYear();
        const todayM = today.getMonth();
        const todayD = today.getDate();

        const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
        const daysInMonth = new Date(
          currentCalendarYear,
          currentCalendarMonth + 1,
          0
        ).getDate();

        calendarGrid.innerHTML = "";

        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        dayNames.forEach((d) => {
          const head = document.createElement("div");
          head.textContent = d;
          head.className = "calendar-day-header";
          calendarGrid.appendChild(head);
        });

        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement("div");
          empty.className = "calendar-empty";
          calendarGrid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.textContent = day;
          cell.className = "calendar-day";

          const cellDate = new Date(currentCalendarYear, currentCalendarMonth, day);
          // Build date string in local time to avoid timezone shifting issues
          const y = cellDate.getFullYear();
          const m = String(cellDate.getMonth() + 1).padStart(2, "0");
          const d = String(cellDate.getDate()).padStart(2, "0");
          const dateStr = `${y}-${m}-${d}`;
          const isToday =
            cellDate.getFullYear() === todayY &&
            cellDate.getMonth() === todayM &&
            cellDate.getDate() === todayD;

          if (isToday) {
            cell.classList.add("today");
          }

          if (selectedDateStr === dateStr) {
            cell.classList.add("selected-date");
          }

          // Disable past dates and current day (no same-day booking)
          if (cellDate <= new Date(todayY, todayM, todayD)) {
            cell.classList.add("disabled-date");
          } else {
            // Click handler for selectable dates (weekdays only)
            cell.addEventListener("click", () => {
              const weekday = cellDate.getDay();
              if (weekday === 0 || weekday === 6) {
                alert("Please select a weekday (Monday to Friday).");
                return;
              }

              selectedDateStr = dateStr;

              document
                .querySelectorAll(".calendar-day")
                .forEach((dEl) => dEl.classList.remove("selected-date"));
              cell.classList.add("selected-date");

              const bookingDate = document.getElementById("bookDate");
              if (bookingDate) {
                bookingDate.value = selectedDateStr;
                bookingDate.dispatchEvent(new Event("change"));
              }

              if (selectedStaffId) {
                loadTimeSlots(selectedDateStr);
              }
            });
          }

          calendarGrid.appendChild(cell);

          // After appending, mark booked days asynchronously
          markDayBookings(dateStr, cell);
        }
      }

      async function markDayBookings(dateStr, cell) {
        try {
          if (dayAvailabilityCache[dateStr]) {
            if (dayAvailabilityCache[dateStr].hasBookings) {
              cell.classList.add("has-booking-date");
            }
            return;
          }

          const res = await fetch(
            `${API_BASE}/bookings/available-slots?date=${encodeURIComponent(
              dateStr
            )}`
          );
          const data = await res.json();

          if (!data.success || !data.data) {
            dayAvailabilityCache[dateStr] = { hasBookings: false, fullyBooked: false };
            return;
          }

          const bookedSlots = data.data.booked_slots || [];
          const availableSlots = data.data.available_slots || [];
          const hasBookings = bookedSlots.length > 0;
          const fullyBooked = hasBookings && availableSlots.length === 0;

          dayAvailabilityCache[dateStr] = { hasBookings, fullyBooked };

          if (hasBookings) {
            cell.classList.add("has-booking-date");
            if (fullyBooked) {
              cell.classList.add("fully-booked-date");
            }
          }
        } catch (err) {
          console.error("Error checking day bookings", err);
        }
      }

      // Load service when page loads
      window.addEventListener("DOMContentLoaded", () => {
        loadServiceDetails();
      });
    </script>
  </body>
</html>
