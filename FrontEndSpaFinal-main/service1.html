<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Service - Nature's Foot Spa</title>
    <link rel="stylesheet" href="servicedescriptionandinfo.css" />
  </head>
  <body>
    <main class="page" id="mainContent">
      <!-- LOADING STATE -->
      <section class="card loading" id="loadingState">
        <p>Loading service details...</p>
      </section>
    </main>

    <script>
      const API_BASE = "http://localhost:3000/api";
      let currentService = null;

      // Get service_id from URL parameter
      function getServiceIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("service_id");
      }

      // Load service details
      async function loadServiceDetails() {
        const serviceId = getServiceIdFromURL();

        console.log("Loading service ID:", serviceId);

        if (!serviceId) {
          showError(
            "No service selected. Please go back and select a service."
          );
          return;
        }

        try {
          console.log("Fetching from:", `${API_BASE}/services`);

          const response = await fetch(`${API_BASE}/services`);

          console.log("Response status:", response.status);

          const data = await response.json();

          console.log("Response data:", data);

          if (data.success && data.data && data.data.length > 0) {
            // Find the specific service
            const service = data.data.find((s) => s.SERVICE_ID == serviceId);

            console.log("Found service:", service);

            if (service) {
              currentService = service;
              displayService(service);
            } else {
              showError(
                `Service with ID ${serviceId} not found. Please go back and select a valid service.`
              );
            }
          } else {
            showError("No services available. Please contact support.");
          }
        } catch (error) {
          console.error("Fetch error:", error);
          showError(
            "Connection error: " +
              error.message +
              ". Make sure the backend server is running on localhost:3000"
          );
        }
      }

      // Display service details
      function displayService(service) {
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = `
                <!-- PRODUCT DESCRIPTION -->
                <section class="product card">
                    <img class="product-img" 
                         src="images/service-${service.SERVICE_ID}.jpg" 
                         alt="${service.SERVICE_NAME}"
                         onerror="this.src='images/sig.jpg'" />

                    <div class="product-info">
                        <h1 class="product-title">${service.SERVICE_NAME}</h1>
                        <p class="product-tagline">${
                          service.SERVICE_NAME
                        } Service</p>

                        <p class="product-desc">
                            ${
                              service.DESCRIPTION ||
                              "Experience professional service tailored to your needs. Our expert team provides quality care with attention to detail."
                            }
                        </p>

                        <div class="price-row">
                            <div class="price">₱${parseFloat(
                              service.PRICE
                            ).toFixed(2)}</div>
                        </div>
                    </div>
                </section>

                <!-- DATE PICKER -->
                <section class="datepicker card" aria-labelledby="booking-information">
                    <h2 id="booking-information">Booking Information</h2>
                    <p class="small">
                        Please select your preferred date and time. Available dates are weekdays only.
                    </p>

                    <form id="dateForm" class="date-form">
                        <label for="bookDate">Pick a date</label>
                        <input id="bookDate" name="bookDate" type="date" required />

                        <label for="bookTime">Preferred time (optional)</label>
                        <input id="bookTime" name="bookingTime" type="time" />

                        <div class="form-actions">
                            <button id="clearBtn" type="button" class="clearBtn">Clear</button>
                            <button type="submit" class="btn">Book</button>
                        </div>

                        <p id="chosen" class="chosen" aria-live="polite"></p>
                    </form>
                </section>
            `;

        // Initialize form handlers after content is loaded
        initializeFormHandlers();
      }

      // Show error message
      function showError(message) {
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = `
                <section class="card" style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545; margin-bottom: 20px;">⚠️ Error</h3>
                    <p style="margin-bottom: 30px;">${message}</p>
                    <a href="index.html" class="btn" style="display: inline-block; text-decoration: none;">
                        Go Back to Home
                    </a>
                </section>
            `;
      }

      // Initialize form event handlers
      function initializeFormHandlers() {
        const bookingDate = document.getElementById("bookDate");
        const bookingTime = document.getElementById("bookTime");
        const chosen = document.getElementById("chosen");
        const form = document.getElementById("dateForm");
        const clearBtn = document.getElementById("clearBtn");

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        bookingDate.setAttribute("min", today);

        // Validate weekday when date changes
        bookingDate.addEventListener("change", () => {
          if (!bookingDate.value) {
            chosen.textContent = "";
            return;
          }

          const date = new Date(bookingDate.value + "T00:00:00");
          const day = date.getDay(); // 0 = Sunday, 6 = Saturday

          if (day === 0 || day === 6) {
            alert("Please select a weekday (Monday to Friday).");
            bookingDate.value = "";
            chosen.textContent = "";
            return;
          }

          updateChosen();
        });

        // Update chosen display when time changes
        bookingTime.addEventListener("change", updateChosen);

        // Clear button
        clearBtn.addEventListener("click", () => {
          bookingDate.value = "";
          bookingTime.value = "";
          chosen.textContent = "";
        });

        // Update chosen display
        function updateChosen() {
          const dateInput = bookingDate.value;
          const timeInput = bookingTime.value;

          if (dateInput && timeInput) {
            const combined = `${dateInput} ${timeInput}`;
            chosen.dataset.datetime = combined;

            const date = new Date(combined);
            const humanDate = date.toLocaleDateString("en-US", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            const humanTime = date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            });

            chosen.textContent = `You have chosen: ${humanDate} at ${humanTime}`;
          } else {
            chosen.textContent = "";
          }
        }

        // Handle form submission
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const date = bookingDate.value;
          const time = bookingTime.value;

          // Validate inputs
          if (!date) {
            alert("Please select a date first!");
            return;
          }
          if (!time) {
            alert("Please select a time first!");
            return;
          }

          // Check if user is logged in
          const token = localStorage.getItem("token");
          if (!token) {
            alert("Please login first to book a service!");
            window.location.href = "Login.html";
            return;
          }

          // Prepare booking data
          const bookingData = {
            service_id: currentService.SERVICE_ID,
            booking_date: date,
            booking_time: time + ":00",
          };

          console.log("Sending booking:", bookingData);

          try {
            const response = await fetch(`${API_BASE}/bookings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(bookingData),
            });

            const data = await response.json();

            if (data.success) {
              alert("✅ Booking created successfully! Proceed to payment.");
              // Redirect to payment page
              window.location.href = "paymentmethod.html";
            } else {
              alert("❌ Error: " + data.message);
            }
          } catch (error) {
            console.error("Booking error:", error);
            alert("❌ Network error: " + error.message);
          }
        });
      }

      // Load service when page loads
      window.addEventListener("DOMContentLoaded", () => {
        loadServiceDetails();
      });
    </script>
  </body>
</html>
