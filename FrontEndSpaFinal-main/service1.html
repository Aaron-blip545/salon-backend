<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Service - Nature's Foot Spa</title>
    <link rel="stylesheet" href="servicedescriptionandinfo.css" />
  </head>
  <body>
    <main class="page" id="mainContent">
      <!-- LOADING STATE -->
      <section class="card loading" id="loadingState">
        <p>Loading service details...</p>
      </section>
    </main>

    <script>
      const API_BASE = "http://localhost:3000/api";
      let currentService = null;

      // Get service_id from URL parameter
      function getServiceIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("service_id");
      }

      // Load service details
      async function loadServiceDetails() {
        const serviceId = getServiceIdFromURL();

        console.log("Loading service ID:", serviceId);

        if (!serviceId) {
          showError(
            "No service selected. Please go back and select a service."
          );
          return;
        }

        try {
          console.log("Fetching from:", `${API_BASE}/services`);

          const response = await fetch(`${API_BASE}/services`);

          console.log("Response status:", response.status);

          const data = await response.json();

          console.log("Response data:", data);

          if (data.success && data.data && data.data.length > 0) {
            // Find the specific service
            const service = data.data.find((s) => s.SERVICE_ID == serviceId);

            console.log("Found service:", service);

            if (service) {
              currentService = service;
              displayService(service);
            } else {
              showError(
                `Service with ID ${serviceId} not found. Please go back and select a valid service.`
              );
            }
          } else {
            showError("No services available. Please contact support.");
          }
        } catch (error) {
          console.error("Fetch error:", error);
          showError(
            "Connection error: " +
              error.message +
              ". Make sure the backend server is running on localhost:3000"
          );
        }
      }

      // Display service details
      let selectedStaffId = null;
      let selectedTimeSlot = null;

      function displayService(service) {
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = `
                <!-- PRODUCT DESCRIPTION -->
                <section class="product card">
                    <img class="product-img" 
                         src="images/service-${service.SERVICE_ID}.jpg" 
                         alt="${service.SERVICE_NAME}"
                         onerror="this.src='images/sig.jpg'" />

                    <div class="product-info">
                        <h1 class="product-title">${service.SERVICE_NAME}</h1>
                        <p class="product-tagline">${
                          service.SERVICE_NAME
                        } Service</p>

                        <p class="product-desc">
                            ${
                              service.DESCRIPTION ||
                              "Experience professional service tailored to your needs. Our expert team provides quality care with attention to detail."
                            }
                        </p>

                        <div class="price-row">
                            <div class="price">₱${parseFloat(
                              service.PRICE
                            ).toFixed(2)}</div>
                        </div>
                    </div>
                </section>

                <!-- DATE PICKER -->
                <section class="datepicker card" aria-labelledby="booking-information">
                    <h2 id="booking-information">Booking Information</h2>
                    <p class="small">
                        Please select your preferred date and time. Available dates are weekdays only.
                    </p>

                    <form id="dateForm" class="date-form">
                        <label for="bookDate">Pick a date</label>
                        <input id="bookDate" name="bookDate" type="date" required />

                        <p class="small">
                          Select your preferred staff and time slot after choosing a date.
                        </p>

                        <div class="form-actions">
                            <button id="clearBtn" type="button" class="clearBtn">Clear</button>
                            <button type="submit" class="btn">Book</button>
                        </div>

                        <p id="chosen" class="chosen" aria-live="polite"></p>
                    </form>
                </section>

                <!-- STAFF SELECTION -->
                <section class="card" id="staffSection">
                    <h2>Select Staff</h2>
                    <p class="small">Choose your preferred staff member for this service.</p>
                    <div id="staffList" style="margin-top:10px;">Loading staff...</div>
                </section>

                <!-- TIME SLOTS -->
                <section class="card" id="timeSlotsSection" style="display:none;">
                    <h2>Available Time Slots</h2>
                    <p class="small" id="selectedStaffLabel"></p>
                    <div id="timeSlotsGrid" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;"></div>
                </section>
            `;

        // Initialize form handlers after content is loaded
        initializeFormHandlers();
        loadStaff();
      }

      async function loadStaff() {
        try {
          const res = await fetch(`${API_BASE}/staff/active`);
          const data = await res.json();
          const staffListEl = document.getElementById("staffList");

          if (!data.success || !data.data || !data.data.length) {
            staffListEl.textContent = "No staff available.";
            return;
          }

          staffListEl.innerHTML = data.data
            .map(
              (s) => `
      <button class="staff-btn" data-staff-id="${s.staff_id}"
        style="border:1px solid #ccc;border-radius:8px;padding:8px 10px;margin:4px;cursor:pointer;background:#f9f9f9;">
        <div style="font-weight:600;">${s.full_name}</div>
        <div style="font-size:12px;color:#666;">
          ${s.role || "Massage Therapist"}${s.gender ? " • " + s.gender : ""}
        </div>
      </button>`
            )
            .join("");

          document.querySelectorAll(".staff-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".staff-btn")
                .forEach((b) => b.classList.remove("selected"));
              btn.classList.add("selected");
              selectedStaffId = btn.getAttribute("data-staff-id");
              document.getElementById("timeSlotsSection").style.display = "block";
              document.getElementById("selectedStaffLabel").textContent =
                "Available times for " + btn.textContent.trim();

              const dateVal = document.getElementById("bookDate").value;
              if (dateVal) {
                loadTimeSlots(dateVal);
              }
            });
          });
        } catch (e) {
          console.error("Error loading staff", e);
          document.getElementById("staffList").textContent =
            "Failed to load staff.";
        }
      }

      function formatTimeToAmPm(time) {
        const [h, m] = time.split(":");
        let hour = parseInt(h, 10);
        const meridiem = hour >= 12 ? "PM" : "AM";
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${m} ${meridiem}`;
      }

      async function loadTimeSlots(date) {
        if (!selectedStaffId) return;
        const grid = document.getElementById("timeSlotsGrid");
        grid.innerHTML = "Loading slots...";

        try {
          const res = await fetch(
            `${API_BASE}/bookings/available-slots?date=${encodeURIComponent(
              date
            )}`
          );
          const data = await res.json();
          if (!data.success) throw new Error(data.message || "Failed to load slots");

          const booked = new Set(data.data.booked_slots || []);
          const hours = [
            "09:00",
            "10:00",
            "11:00",
            "12:00",
            "13:00",
            "14:00",
            "15:00",
            "16:00",
            "17:00",
            "18:00",
            "19:00",
          ];

          grid.innerHTML = "";
          hours.forEach((time) => {
            const isBooked = booked.has(time);
            const btn = document.createElement("button");
            btn.textContent = formatTimeToAmPm(time);
            btn.setAttribute("data-time", time);

            // base style for all buttons
            btn.style.cssText =
              "padding:6px 10px;border-radius:6px;border:1px solid #ccc;cursor:pointer;font-size:13px;background:#f8f9fa;color:#333;min-width:70px;";

            if (isBooked) {
              // booked (red) and disabled
              btn.disabled = true;
              btn.style.background = "#fde2e2"; // light red
              btn.style.color = "#a33";
              btn.style.borderColor = "#f28b82";
              btn.title = "Already booked";
            } else {
              // available: clicking marks as selected (green)
              btn.addEventListener("click", () => {
                document
                  .querySelectorAll("#timeSlotsGrid button")
                  .forEach((b) => {
                    if (b.disabled) {
                      // keep booked style
                      b.style.background = "#fde2e2";
                      b.style.color = "#a33";
                      b.style.borderColor = "#f28b82";
                    } else {
                      // reset available style
                      b.style.background = "#f8f9fa";
                      b.style.color = "#333";
                      b.style.borderColor = "#ccc";
                    }
                  });

                // selected (green)
                btn.style.background = "#c8f7c5"; // light green
                btn.style.borderColor = "#2ecc71";
                btn.style.color = "#1b5e20";
                selectedTimeSlot = btn.getAttribute("data-time");
              });
            }
            grid.appendChild(btn);
          });
        } catch (e) {
          console.error("Error loading slots", e);
          grid.textContent = "Failed to load time slots.";
        }
      }

      // Show error message
      function showError(message) {
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = `
                <section class="card" style="text-align: center; padding: 40px;">
                    <h3 style="color: #dc3545; margin-bottom: 20px;">⚠️ Error</h3>
                    <p style="margin-bottom: 30px;">${message}</p>
                    <a href="index.html" class="btn" style="display: inline-block; text-decoration: none;">
                        Go Back to Home
                    </a>
                </section>
            `;
      }

      // Initialize form event handlers
      function initializeFormHandlers() {
        const bookingDate = document.getElementById("bookDate");
        const chosen = document.getElementById("chosen");
        const form = document.getElementById("dateForm");
        const clearBtn = document.getElementById("clearBtn");

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        bookingDate.setAttribute("min", today);

        // Validate weekday when date changes
        bookingDate.addEventListener("change", () => {
          if (!bookingDate.value) {
            chosen.textContent = "";
            return;
          }

          const date = new Date(bookingDate.value + "T00:00:00");
          const day = date.getDay(); // 0 = Sunday, 6 = Saturday

          if (day === 0 || day === 6) {
            alert("Please select a weekday (Monday to Friday).");
            bookingDate.value = "";
            chosen.textContent = "";
            return;
          }

          updateChosen();
        });

        // Clear button
        clearBtn.addEventListener("click", () => {
          bookingDate.value = "";
          chosen.textContent = "";
          selectedStaffId = null;
          selectedTimeSlot = null;
          const staffListEl = document.getElementById("staffList");
          const timeSlotsGrid = document.getElementById("timeSlotsGrid");
          const timeSlotsSection = document.getElementById("timeSlotsSection");
          if (staffListEl) {
            staffListEl.querySelectorAll(".staff-btn").forEach((b) =>
              b.classList.remove("selected")
            );
          }
          if (timeSlotsGrid) {
            timeSlotsGrid.innerHTML = "";
          }
          if (timeSlotsSection) {
            timeSlotsSection.style.display = "none";
          }
        });

        // Update chosen display
        function updateChosen() {
          const dateInput = bookingDate.value;

          if (dateInput && selectedTimeSlot) {
            const combined = `${dateInput} ${selectedTimeSlot}`;
            chosen.dataset.datetime = combined;

            const date = new Date(combined);
            const humanDate = date.toLocaleDateString("en-US", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            const humanTime = date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            });

            chosen.textContent = `You have chosen: ${humanDate} at ${humanTime}`;
          } else {
            chosen.textContent = "";
          }
        }

        // Handle form submission
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const date = bookingDate.value;

          // Validate inputs
          if (!date) {
            alert("Please select a date first!");
            return;
          }
          if (!selectedStaffId) {
            alert("Please select a staff member.");
            return;
          }
          if (!selectedTimeSlot) {
            alert("Please select a time slot.");
            return;
          }

          // Check if user is logged in
          const token = localStorage.getItem("token");
          if (!token) {
            alert("Please login first to book a service!");
            window.location.href = "loginform.html";
            return;
          }

          const bookingData = {
            service_id: currentService.SERVICE_ID,
            booking_date: date,
            booking_time: selectedTimeSlot,
            staff_id: selectedStaffId,
          };

          try {
            const resp = await fetch(`${API_BASE}/bookings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(bookingData),
            });

            const result = await resp.json();
            if (!resp.ok || !result.success) {
              throw new Error(result.message || "Failed to create booking");
            }

            const created = result.data || {};
            const username =
              localStorage.getItem("userName") ||
              localStorage.getItem("username") ||
              "Guest";

            sessionStorage.setItem(
              "bookingDetails",
              JSON.stringify({
                booking_id: created.BOOKING_ID || created.booking_id,
                service_id: bookingData.service_id,
                service_name: currentService.SERVICE_NAME,
                booking_date: bookingData.booking_date,
                booking_time: bookingData.booking_time,
                price: currentService.PRICE,
                username: username,
              })
            );

            window.location.href = "paymentmethod.html";
          } catch (error) {
            console.error("Booking error:", error);
            alert("Could not create booking: " + error.message);
          }
        });
      }

      // Load service when page loads
      window.addEventListener("DOMContentLoaded", () => {
        loadServiceDetails();
      });
    </script>
  </body>
</html>
